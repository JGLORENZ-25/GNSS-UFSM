<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTK Data Collector</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://cdn.jsdelivr.net/npm/nmea-parser/browser/nmea-parser.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 10px auto; padding: 10px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); }
        .header { text-align: center; padding: 20px; background: linear-gradient(90deg, #2196F3, #21CBF3); border-radius: 15px 15px 0 0; color: white; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: pulse 4s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 0.1; transform: scale(1.1); } }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; position: relative; z-index: 1; }
        .header p { font-size: 1.1em; opacity: 0.9; position: relative; z-index: 1; }
        .tabs { display: flex; background: #f5f5f5; border-radius: 10px; margin: 20px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 15px; background: transparent; border: none; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; position: relative; }
        .tab.active { background: linear-gradient(135deg, #2196F3, #21CBF3); color: white; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3); }
        .tab:hover:not(.active) { background: rgba(33, 150, 243, 0.1); transform: translateY(-1px); }
        .content { padding: 20px; }
        .tab-content { display: none; animation: fadeIn 0.5s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: white; border-radius: 15px; padding: 25px; margin: 20px 0; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); }
        .form-group { margin: 20px 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9); }
        .form-control:focus { outline: none; border-color: #2196F3; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1); transform: translateY(-1px); }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden; }
        .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255, 255, 255, 0.2); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .btn:active::before { width: 300px; height: 300px; }
        .btn-primary { background: linear-gradient(135deg, #2196F3, #21CBF3); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4); }
        .btn-success { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #FF9800, #F57C00); color: white; }
        .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #f44336, #d32f2f); color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .status { padding: 15px; border-radius: 10px; margin: 15px 0; font-weight: 600; text-align: center; border-left: 5px solid; animation: slideIn 0.5s ease; }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .status.connected { background: #e8f5e8; color: #2e7d32; border-color: #4caf50; }
        .status.connecting { background: #fff3e0; color: #ef6c00; border-color: #ff9800; }
        .status.disconnected { background: #ffebee; color: #c62828; border-color: #f44336; }
        .status.info { background: #e3f2fd; color: #1565c0; border-color: #2196f3; }
        .data-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .data-item { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid transparent; transition: all 0.3s ease; }
        .data-item:hover { border-color: #2196F3; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2); }
        .data-item .label { font-size: 0.8em; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .data-item .value { font-size: 1.4em; font-weight: bold; color: #2196F3; }
        .points-list { max-height: 400px; overflow-y: auto; background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 20px 0; }
        .point-item { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #2196F3; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        .point-item:hover { transform: translateX(5px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); }
        .button-group { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin: 25px 0; }
        .map-container { height: 400px; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); margin: 20px 0; background: #e3f2fd; }
        .current-location-icon { font-size: 24px; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        @media (max-width: 768px) {
            .container { margin: 5px; border-radius: 15px; }
            .header h1 { font-size: 2em; }
            .tabs { flex-direction: column; margin: 10px; }
            .button-group { flex-direction: column; }
            .btn { padding: 12px 25px; }
            .data-display { grid-template-columns: 1fr 1fr; gap: 15px; }
        }
        .floating-action { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4); transition: all 0.3s ease; z-index: 1000; }
        .floating-action:hover { transform: scale(1.1) rotate(5deg); box-shadow: 0 12px 30px rgba(76, 175, 80, 0.6); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° RTK Data Collector</h1>
            <p>Sistema de Coleta GNSS/RTK</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('connection')">üîó Conex√£o</button>
            <button class="tab" onclick="showTab('gnss')">üõ∞Ô∏è GNSS</button>
            <button class="tab" onclick="showTab('collection')">üìç Coleta</button>
            <button class="tab" onclick="showTab('data')">üìä Dados</button>
            <button class="tab" onclick="showTab('export')">üíæ Exportar</button>
        </div>

        <div class="content">
            <div id="gnss" class="tab-content">
                <div class="card">
                    <h3>üì± Sistema de Posicionamento</h3>
                    <div class="form-group">
                        <label>Fonte de Localiza√ß√£o:</label>
                        <select class="form-control" id="locationMode" onchange="changeLocationMode()">
                            <option value="device">üì± GNSS do Dispositivo (Celular/PC)</option>
                            <option value="rtk">üõ∞Ô∏è Receptor RTK Externo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Configura√ß√µes de Precis√£o (Apenas para GNSS do Dispositivo):</label>
                        <select class="form-control" id="accuracyMode" onchange="changeAccuracyMode()">
                            <option value="high">üéØ Alta Precis√£o</option>
                            <option value="balanced" selected>‚öñÔ∏è Balanceado (Recomendado)</option>
                            <option value="low">‚ö° Baixo Consumo</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="startDeviceGNSS()"><span id="deviceGnssText">üõ∞Ô∏è Ativar GNSS do Dispositivo</span></button>
                        <button class="btn btn-danger" onclick="stopDeviceGNSS()">‚èπÔ∏è Parar GNSS do Dispositivo</button>
                    </div>
                    <div id="gnssStatus" class="status info">‚ÑπÔ∏è GNSS do dispositivo pronto para uso</div>
                </div>
                <div class="card">
                    <h3>üìä Informa√ß√µes dos Sat√©lites (Recebidas do Equipamento)</h3>
                    <div class="data-display">
                        <div class="data-item"><div class="label">GPS</div><div class="value" id="gpsCount">--</div></div>
                        <div class="data-item"><div class="label">GLONASS</div><div class="value" id="glonassCount">--</div></div>
                        <div class="data-item"><div class="label">Galileo</div><div class="value" id="galileoCount">--</div></div>
                        <div class="data-item"><div class="label">BeiDou</div><div class="value" id="beidouCount">--</div></div>
                        <div class="data-item"><div class="label">Status RTK</div><div class="value" id="rtkStatusValue">--</div></div>
                        <div class="data-item"><div class="label">HDOP</div><div class="value" id="hdopValue">--</div></div>
                    </div>
                </div>
            </div>

            <div id="connection" class="tab-content active">
                <div class="card">
                    <h3>üì∑ Receptor GNSS Bluetooth</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">Pareie seu receptor (Ex: South S82-T) com o seu computador ou celular antes de conectar.</p>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="connectBluetooth()"><span id="btConnectText">üì± Conectar Bluetooth</span></button>
                        <button class="btn btn-danger" onclick="disconnect()">‚ùå Desconectar</button>
                    </div>
                    <div id="connectionStatus" class="status disconnected">‚ùå Desconectado - Aguardando conex√£o</div>
                </div>
            </div>

            <div id="collection" class="tab-content">
                <div class="card">
                    <h3>üìç Dados GNSS Atuais</h3>
                    <div class="data-display">
                        <div class="data-item"><div class="label">Latitude</div><div class="value" id="currentLat">--¬∞</div></div>
                        <div class="data-item"><div class="label">Longitude</div><div class="value" id="currentLon">--¬∞</div></div>
                        <div class="data-item"><div class="label">Altitude</div><div class="value" id="currentAlt">-- m</div></div>
                        <div class="data-item"><div class="label">Precis√£o Horiz.</div><div class="value" id="currentAccuracy">-- m</div></div>
                        <div class="data-item"><div class="label">Sat√©lites</div><div class="value" id="satellites">--</div></div>
                        <div class="data-item"><div class="label">Fonte Ativa</div><div class="value" id="activeSystem">NENHUMA</div></div>
                    </div>
                    <div id="positioningStatus" class="status info">‚ÑπÔ∏è Selecione uma fonte de localiza√ß√£o na aba GNSS ou conecte um receptor RTK</div>
                </div>
                <div class="card">
                    <h3>üéØ Tipos de Coleta</h3>
                    <div class="button-group">
                        <button class="btn btn-success" onclick="collectPoint('POINT')" id="collectPointBtn">üìç Coletar Ponto</button>
                        <button class="btn btn-warning" onclick="startLine()" id="lineBtn">üìè Iniciar Linha</button>
                        <button class="btn btn-warning" onclick="startPolygon()" id="polygonBtn">üìê Iniciar Pol√≠gono</button>
                    </div>
                    <div class="form-group"><label>Descri√ß√£o do Ponto/V√©rtice:</label><input type="text" class="form-control" id="pointDescription" placeholder="Ex: Marco, Poste, V√©rtice..."></div>
                    <div id="collectionStatus" class="status info">‚ÑπÔ∏è Pronto para coletar</div>
                </div>
                <div id="map" class="map-container"></div>
            </div>

            <div id="data" class="tab-content">
                <div class="card">
                    <h3>üìä Resumo da Coleta</h3>
                    <div class="data-display">
                        <div class="data-item"><div class="label">Total Pontos</div><div class="value" id="totalPoints">0</div></div>
                        <div class="data-item"><div class="label">Linhas</div><div class="value" id="totalLines">0</div></div>
                        <div class="data-item"><div class="label">Pol√≠gonos</div><div class="value" id="totalPolygons">0</div></div>
                        <div class="data-item"><div class="label">Precis√£o M√©dia</div><div class="value" id="avgAccuracy">-- m</div></div>
                    </div>
                </div>
                <div class="card">
                    <h3>üìã Lista de Pontos Coletados</h3>
                    <div class="button-group">
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Limpar Tudo</button>
                        <button class="btn btn-primary" onclick="refreshData()">üîÑ Atualizar</button>
                    </div>
                    <div id="pointsList" class="points-list">
                        <div style="text-align: center; color: #666; padding: 20px;">üìç Nenhum ponto coletado ainda</div>
                    </div>
                </div>
            </div>

            <div id="export" class="tab-content">
                <div class="card">
                    <h3>üíæ Exportar Dados</h3>
                    <div class="form-group"><label>Nome do Projeto:</label><input type="text" class="form-control" id="projectName" placeholder="Ex: Levantamento_Area_01"></div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="exportGeoJSON()">üåê Exportar GeoJSON</button>
                        <button class="btn btn-primary" onclick="exportCSV()">üìä Exportar CSV</button>
                    </div>
                    <div id="exportStatus" class="status info">üí° Selecione o formato desejado para exporta√ß√£o</div>
                </div>
                <div class="card">
                    <h3>‚öôÔ∏è Configura√ß√µes de Exporta√ß√£o</h3>
                    <div class="form-group"><label>Sistema de Coordenadas:</label><select class="form-control" id="coordinateSystem"><option value="WGS84">WGS84 (Padr√£o GPS)</option></select></div>
                    <div class="form-group"><label>Precis√£o Decimal:</label><select class="form-control" id="precision"><option value="8">8 casas (¬±1cm)</option><option value="9">9 casas (¬±1mm)</option></select></div>
                </div>
            </div>
        </div>
    </div>
    <button class="floating-action" onclick="quickCollect()" title="Coleta R√°pida (Ctrl+Enter)">‚ö°</button>

<script>
let appState = {
    isConnected: false,
    collectedPoints: [],
    currentGeometry: null,
    geometryType: 'POINT',
    isCollecting: false,
    bluetoothDevice: null,
    currentLocation: { lat: 0, lon: 0, alt: 0, accuracy: 99, satellites: 0, rtkStatus: '--', hdop: '--' },
    locationMode: 'device',
    deviceWatchId: null,
    btCharacteristic: null,
};

let map = null, currentLocationMarker = null, accuracyCircle = null, collectedPointsLayer = null;

document.addEventListener('DOMContentLoaded', () => {
    initializePWA();
    loadStoredData();
    changeLocationMode(); 
});

function initializePWA() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(reg => console.log('Service Worker registrado')).catch(err => console.error('Falha no registro do Service Worker:', err));
    }
}

// ================================
// CONTROLE DE LOCALIZA√á√ÉO E BLUETOOTH
// ================================

function changeLocationMode() {
    const mode = document.getElementById('locationMode').value;
    appState.locationMode = mode;
    if (mode === 'device') {
        startDeviceGNSS();
        disconnect(); // Garante que a conex√£o BT seja encerrada
    } else {
        stopDeviceGNSS();
    }
    updateLocationDisplay();
}

async function connectBluetooth() {
    if (!navigator.bluetooth) {
        alert('A Web Bluetooth API n√£o √© suportada neste navegador. Tente usar o Chrome ou Edge.');
        return;
    }
    const connectBtn = document.getElementById('btConnectText');
    try {
        stopDeviceGNSS();
        updateConnectionStatus('connecting', 'üîÑ Procurando por dispositivos Bluetooth...');
        connectBtn.innerHTML = '<span class="loading"></span>Procurando...';

        const device = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: 'South' }, { namePrefix: 'S82' }],
            optionalServices: ['00001101-0000-1000-8000-00805f9b34fb'] // UUID Padr√£o para Serial Port Profile (SPP)
        });
        
        device.addEventListener('gattserverdisconnected', onDisconnected);
        updateConnectionStatus('connecting', `üîå Conectando ao ${device.name}...`);
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
        const characteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');
        
        await characteristic.startNotifications();
        
        const nmeaParser = new NmeaParser();
        const textDecoder = new TextDecoder();
        let nmeaBuffer = '';

        characteristic.addEventListener('characteristicvaluechanged', event => {
            nmeaBuffer += textDecoder.decode(event.target.value);
            let newlineIndex;
            while ((newlineIndex = nmeaBuffer.indexOf('\n')) >= 0) {
                const sentence = nmeaBuffer.substring(0, newlineIndex).trim();
                nmeaBuffer = nmeaBuffer.substring(newlineIndex + 1);
                if (sentence.startsWith('$')) {
                    try {
                        const parsedData = nmeaParser.parse(sentence);
                        if (parsedData.latitude && parsedData.longitude) {
                            updateStateWithRealData(parsedData);
                        }
                    } catch (e) { /* Ignora senten√ßas malformadas */ }
                }
            }
        });
        
        appState.isConnected = true;
        appState.bluetoothDevice = device;
        appState.btCharacteristic = characteristic;
        appState.locationMode = 'rtk';
        document.getElementById('locationMode').value = 'rtk';

        updateConnectionStatus('connected', `‚úÖ Conectado via Bluetooth a ${device.name}`);
        connectBtn.textContent = 'üì± Conectar Bluetooth';

    } catch (error) {
        console.error('‚ùå Erro na conex√£o Bluetooth:', error);
        updateConnectionStatus('disconnected', '‚ùå Erro: ' + error.message);
        connectBtn.textContent = 'üì± Conectar Bluetooth';
    }
}

function updateStateWithRealData(data) {
    const qualityMap = { 0: 'Inv√°lido', 1: 'GPS', 2: 'DGPS', 4: 'RTK Fixo', 5: 'RTK Flutuante' };
    
    appState.currentLocation = {
        lat: data.latitude,
        lon: data.longitude,
        alt: data.altitude || 0,
        accuracy: data.hdop ? (data.hdop * 1.5).toFixed(2) : 99, // Estimativa de precis√£o
        satellites: data.satellitesInView || data.satellites?.length || 0,
        hdop: data.hdop || '--',
        rtkStatus: qualityMap[data.fixQuality] || 'N/A'
    };
    
    if (data.satellites) {
        document.getElementById('gpsCount').textContent = data.satellites.filter(s => s.prn >= 1 && s.prn <= 32).length;
        document.getElementById('glonassCount').textContent = data.satellites.filter(s => s.prn >= 65 && s.prn <= 96).length;
        document.getElementById('beidouCount').textContent = data.satellites.filter(s => s.prn >= 201 && s.prn <= 236).length;
        document.getElementById('galileoCount').textContent = data.satellites.filter(s => s.prn >= 301 && s.prn <= 336).length;
    }

    if (appState.locationMode === 'rtk') {
        updateLocationDisplay();
    }
}

async function disconnect() {
    if (appState.bluetoothDevice && appState.bluetoothDevice.gatt.connected) {
        appState.bluetoothDevice.gatt.disconnect();
    } else {
        onDisconnected();
    }
}

function onDisconnected() {
    if (appState.btCharacteristic) {
        appState.btCharacteristic.removeEventListener('characteristicvaluechanged', ()=>{});
        appState.btCharacteristic = null;
    }
    appState.isConnected = false;
    appState.bluetoothDevice = null;
    updateConnectionStatus('disconnected', '‚ùå Desconectado');
    console.log('Dispositivo Bluetooth desconectado.');
}

function startDeviceGNSS() {
    if (!navigator.geolocation) { return; }
    const options = { enableHighAccuracy: document.getElementById('accuracyMode').value === 'high', timeout: 10000, maximumAge: 0 };
    appState.deviceWatchId = navigator.geolocation.watchPosition(
        position => {
            const { latitude, longitude, altitude, accuracy } = position.coords;
            appState.currentLocation = { lat: latitude, lon: longitude, alt: altitude || 0, accuracy: accuracy.toFixed(2), satellites: '--', hdop: '--', rtkStatus: 'N/A' };
            if (appState.locationMode === 'device') {
                updateLocationDisplay();
            }
        },
        () => { updatePositioningStatus('disconnected', '‚ùå Erro ao obter localiza√ß√£o do dispositivo.'); },
        options
    );
    document.getElementById('gnssStatus').className = 'status connected';
    document.getElementById('gnssStatus').textContent = '‚úÖ GNSS do dispositivo ATIVO';
}

function stopDeviceGNSS() {
    if (appState.deviceWatchId) {
        navigator.geolocation.clearWatch(appState.deviceWatchId);
        appState.deviceWatchId = null;
    }
    document.getElementById('gnssStatus').className = 'status info';
    document.getElementById('gnssStatus').textContent = '‚ÑπÔ∏è GNSS do dispositivo parado';
}


// ================================
// GERENCIAMENTO DE DADOS E PONTOS
// ================================

function collectPoint(type = 'POINT') {
    const hasDeviceLocation = appState.locationMode === 'device' && appState.deviceWatchId;
    const hasRTKLocation = appState.locationMode === 'rtk' && appState.isConnected;
    
    if ((!hasDeviceLocation && !hasRTKLocation) || appState.currentLocation.lat === 0) {
        updateCollectionStatus('info', '‚ö†Ô∏è Aguardando uma localiza√ß√£o v√°lida...');
        return;
    }

    const description = document.getElementById('pointDescription').value || `Ponto ${appState.collectedPoints.length + 1}`;
    
    const point = {
        id: Date.now(),
        type: type,
        latitude: appState.currentLocation.lat,
        longitude: appState.currentLocation.lon,
        altitude: appState.currentLocation.alt,
        accuracy: appState.currentLocation.accuracy,
        satellites: appState.currentLocation.satellites,
        hdop: appState.currentLocation.hdop,
        locationSource: appState.locationMode.toUpperCase(),
        rtkStatus: appState.currentLocation.rtkStatus,
        description: description,
        timestamp: new Date().toISOString(),
        geometry: appState.currentGeometry,
    };

    appState.collectedPoints.push(point);
    addPointToMap(point);
    saveDataToStorage();
    
    updateCollectionStatus('connected', `‚úÖ Ponto coletado! Precis√£o: ${point.accuracy}m`);
    document.getElementById('pointDescription').value = '';
    
    animateCollection();
    updateDataSummary();
}

function startLine() {
    appState.geometryType = 'LINE';
    appState.currentGeometry = 'LINE_' + Date.now();
    updateCollectionStatus('connecting', 'üìè Modo LINHA ativo. Colete os v√©rtices.');
    document.getElementById('lineBtn').textContent = '‚èπÔ∏è Finalizar Linha';
    document.getElementById('lineBtn').onclick = finishGeometry;
    document.getElementById('polygonBtn').disabled = true;
}

function startPolygon() {
    appState.geometryType = 'POLYGON';
    appState.currentGeometry = 'POLYGON_' + Date.now();
    updateCollectionStatus('connecting', 'üìê Modo POL√çGONO ativo. Colete os v√©rtices.');
    document.getElementById('polygonBtn').textContent = '‚èπÔ∏è Finalizar Pol√≠gono';
    document.getElementById('polygonBtn').onclick = finishGeometry;
    document.getElementById('lineBtn').disabled = true;
}

function finishGeometry() {
    appState.geometryType = 'POINT';
    appState.currentGeometry = null;
    updateCollectionStatus('info', '‚úÖ Geometria finalizada.');
    document.getElementById('lineBtn').textContent = 'üìè Iniciar Linha';
    document.getElementById('lineBtn').onclick = startLine;
    document.getElementById('polygonBtn').textContent = 'üìê Iniciar Pol√≠gono';
    document.getElementById('polygonBtn').onclick = startPolygon;
    document.getElementById('lineBtn').disabled = false;
    document.getElementById('polygonBtn').disabled = false;
}

// ================================
// MAPA E INTERFACE
// ================================

function initializeMap() {
    if (map) return;
    try {
        map = L.map('map').setView([-14.235, -51.925], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        collectedPointsLayer = L.layerGroup().addTo(map);
        appState.collectedPoints.forEach(addPointToMap);
    } catch (e) {
        console.error("Erro ao inicializar o mapa:", e);
        document.getElementById('map').innerHTML = 'Falha ao carregar o mapa.';
    }
}

function addPointToMap(point) {
    if (!map || !collectedPointsLayer) return;
    const marker = L.marker([point.latitude, point.longitude]);
    marker.bindPopup(`<strong>${point.description}</strong><br>Precis√£o: ${point.accuracy} m<br>Status: ${point.rtkStatus}`);
    collectedPointsLayer.addLayer(marker);
}

function updateLocationDisplay() {
    const loc = appState.currentLocation;
    document.getElementById('currentLat').textContent = loc.lat.toFixed(8) + '¬∞';
    document.getElementById('currentLon').textContent = loc.lon.toFixed(8) + '¬∞';
    document.getElementById('currentAlt').textContent = loc.alt.toFixed(2) + ' m';
    document.getElementById('currentAccuracy').textContent = `${loc.accuracy} m`;
    document.getElementById('satellites').textContent = loc.satellites;
    document.getElementById('activeSystem').textContent = appState.locationMode.toUpperCase();
    document.getElementById('rtkStatusValue').textContent = loc.rtkStatus;
    document.getElementById('hdopValue').textContent = loc.hdop;

    const statusMessage = appState.locationMode === 'device' 
        ? `‚úÖ GNSS do dispositivo ativo`
        : (appState.isConnected ? `‚úÖ Receptor RTK ativo` : `‚ùå Conecte o receptor RTK`);
    updatePositioningStatus(appState.isConnected || appState.deviceWatchId ? 'connected' : 'disconnected', statusMessage);

    if (map && loc.lat !== 0 && loc.lon !== 0) {
        const latLng = [loc.lat, loc.lon];
        const accuracyRadius = Math.min(parseFloat(loc.accuracy) || 0, 10000); // Limita o raio
        if (!currentLocationMarker) {
            const icon = L.divIcon({ html: 'üìç', className: 'current-location-icon', iconSize: [30, 30], iconAnchor: [15, 30] });
            currentLocationMarker = L.marker(latLng, { icon }).addTo(map);
            accuracyCircle = L.circle(latLng, { radius: accuracyRadius, weight: 1, color: '#136AEC', fillColor: '#136AEC', fillOpacity: 0.15 }).addTo(map);
            map.setView(latLng, 18);
        } else {
            currentLocationMarker.setLatLng(latLng);
            accuracyCircle.setLatLng(latLng).setRadius(accuracyRadius);
            if (map.getBounds().contains(latLng) === false) {
                 map.panTo(latLng);
            }
        }
    }
}


function updateDataSummary() {
    const pointsCount = appState.collectedPoints.length;
    document.getElementById('totalPoints').textContent = pointsCount;
    document.getElementById('totalLines').textContent = new Set(appState.collectedPoints.filter(p => p.geometry?.startsWith('LINE_')).map(p => p.geometry)).size;
    document.getElementById('totalPolygons').textContent = new Set(appState.collectedPoints.filter(p => p.geometry?.startsWith('POLYGON_')).map(p => p.geometry)).size;
    const avgAccuracy = pointsCount > 0 ? (appState.collectedPoints.reduce((sum, p) => sum + parseFloat(p.accuracy), 0) / pointsCount).toFixed(3) : '--';
    document.getElementById('avgAccuracy').textContent = `${avgAccuracy} m`;
    updatePointsList();
}

function updatePointsList() {
    const listContainer = document.getElementById('pointsList');
    if (appState.collectedPoints.length === 0) {
        listContainer.innerHTML = `<div style="text-align: center; color: #666; padding: 20px;">üìç Nenhum ponto coletado ainda</div>`;
        return;
    }
    listContainer.innerHTML = appState.collectedPoints.map(p => `
        <div class="point-item">
            <strong>${p.description}</strong><br>
            <small>${p.latitude.toFixed(7)}¬∞, ${p.longitude.toFixed(7)}¬∞ | Precis√£o: ${p.accuracy}m | Status: ${p.rtkStatus}</small>
        </div>`).join('');
}

function clearAllData() {
    if (confirm('Tem certeza que deseja apagar todos os dados coletados?')) {
        appState.collectedPoints = [];
        if (collectedPointsLayer) collectedPointsLayer.clearLayers();
        saveDataToStorage();
        updateDataSummary();
        updateCollectionStatus('info', 'Todos os dados foram removidos');
    }
}

function refreshData() {
    updateDataSummary();
    updateCollectionStatus('info', 'Dados atualizados');
}

// ================================
// EXPORTA√á√ÉO E PERSIST√äNCIA
// ================================

function exportGeoJSON() {
    if (appState.collectedPoints.length === 0) return alert('Nenhum ponto para exportar.');
    const projectName = document.getElementById('projectName').value || 'RTK_Collection';
    const precision = parseInt(document.getElementById('precision').value);
    const geojson = {
        type: "FeatureCollection", name: projectName,
        features: appState.collectedPoints.map(p => ({
            type: "Feature",
            properties: { name: p.description, accuracy: p.accuracy, satellites: p.satellites, rtk_status: p.rtkStatus, hdop: p.hdop, timestamp: p.timestamp },
            geometry: { type: "Point", coordinates: [parseFloat(p.longitude.toFixed(precision)), parseFloat(p.latitude.toFixed(precision)), parseFloat(p.altitude.toFixed(2))] }
        }))
    };
    downloadFile(`${projectName}.geojson`, JSON.stringify(geojson, null, 2), 'application/geo+json');
}

function exportCSV() {
    if (appState.collectedPoints.length === 0) return alert('Nenhum ponto para exportar.');
    const projectName = document.getElementById('projectName').value || 'RTK_Collection';
    const precision = parseInt(document.getElementById('precision').value);
    let csvContent = 'ID,Nome,Latitude,Longitude,Altitude,Precisao_m,Status_RTK,Satelites,HDOP,Data_Coleta\n';
    appState.collectedPoints.forEach((p, i) => {
        csvContent += `${i + 1},"${p.description}",${p.latitude.toFixed(precision)},${p.longitude.toFixed(precision)},${p.altitude.toFixed(2)},${p.accuracy},"${p.rtkStatus}",${p.satellites},${p.hdop},"${p.timestamp}"\n`;
    });
    downloadFile(`${projectName}.csv`, csvContent, 'text/csv;charset=utf-8;');
}

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function saveDataToStorage() {
    try {
        const stateToSave = { ...appState, bluetoothDevice: null, btCharacteristic: null };
        localStorage.setItem('rtkCollectorAppState', JSON.stringify(stateToSave));
    } catch (e) { console.warn('Erro ao salvar dados:', e); }
}

function loadStoredData() {
    const storedState = localStorage.getItem('rtkCollectorAppState');
    if (storedState) {
        Object.assign(appState, JSON.parse(storedState));
        appState.bluetoothDevice = null;
        appState.btCharacteristic = null;
        appState.isConnected = false;
        updateDataSummary();
    }
}

// ================================
// FUN√á√ïES UTILIT√ÅRIAS DE UI
// ================================

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
    if (tabName === 'collection') {
        if (!map) initializeMap();
        else setTimeout(() => map.invalidateSize(), 100);
    }
    if (tabName === 'data') updateDataSummary();
}

function quickCollect() { collectPoint('POINT'); }
function animateCollection() {
    const btn = document.getElementById('collectPointBtn');
    btn.style.transform = 'scale(1.1)';
    setTimeout(() => { btn.style.transform = 'scale(1)'; }, 300);
}

function updateConnectionStatus(status, message) { document.getElementById('connectionStatus').className = `status ${status}`; document.getElementById('connectionStatus').textContent = message; }
function updatePositioningStatus(status, message) { document.getElementById('positioningStatus').className = `status ${status}`; document.getElementById('positioningStatus').textContent = message; }
function updateCollectionStatus(status, message) { document.getElementById('collectionStatus').className = `status ${status}`; document.getElementById('collectionStatus').textContent = message; }

document.addEventListener('keydown', e => { if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); quickCollect(); } });
setInterval(saveDataToStorage, 60000);

</script>
</body>
</html>